<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Seguimiento IT</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}

.header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
    font-weight: 300;
}

.header p {
    opacity: 0.9;
    font-size: 1.1em;
}

.tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.tab {
    flex: 1;
    padding: 15px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.tab.active {
    background: white;
    border-bottom-color: #007bff;
    color: #007bff;
    font-weight: 600;
}

.tab:hover:not(.active) {
    background: #e9ecef;
}

.tab-content {
    display: none;
    padding: 30px;
}

.tab-content.active {
    display: block;
}

.form-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
    border-left: 4px solid #007bff;
}

.form-section h3 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 1.3em;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #495057;
}

input, select, textarea {
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1em;
    transition: border-color 0.3s ease;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,123,255,0.3);
}

.btn-export {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    margin-left: 10px;
}

.table-container {
    overflow-x: auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

th {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

td {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

tr:hover {
    background: #f8f9fa;
}

.status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    text-align: center;
}

.status.pendiente { background: #fff3cd; color: #856404; }
.status.en-progreso { background: #cce5ff; color: #004085; }
.status.completado { background: #d4edda; color: #155724; }
.status.bloqueado { background: #f8d7da; color: #721c24; }

.area-tag {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    text-align: center;
    color: white;
}

.area-tag.desarrollo { background: #007bff; }
.area-tag.dise√±o { background: #6610f2; }
.area-tag.pruebas { background: #6f42c1; }
.area-tag.soporte { background: #e83e8c; }
.area-tag.mejoras { background: #dc3545; }
.area-tag.documentaci√≥n { background: #28a745; }
.area-tag.reuniones { background: #17a2b8; }
.area-tag.formaci√≥n { background: #fd7e14; }
.area-tag.mantenimiento { background: #6c757d; }
.area-tag.otros { background: #343a40; }

/* Estilos para el tab Actualizar Horas */
.tarea-actualizar {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #007bff;
}

.tarea-actualizar .tarea-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}

.tarea-actualizar .tarea-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
    font-size: 0.9em;
    color: #6c757d;
}

.tarea-actualizar .btn-sm {
    padding: 8px 15px;
    font-size: 0.85em;
}

.borde-excedido {
    border-bottom-color: #ffc107;
    color: #856404;
}

.fila-inactiva {
    background-color: #f8f9fa;
    color: #6c757d;
}

.fila-completada {
    background-color: #e8f5e9;
}

.fila-bloqueada {
    background-color: #ffebee;
}

.fila-retrasada {
    background-color: #fff3e0;
}

.fila-excedida {
    background-color: #fff8e1;
}

.fila-resumen {
    background-color: #e3f2fd;
    font-weight: bold;
    border-top: 2px solid #90caf9;
    border-bottom: 2px solid #90caf9;
}

.text-center {
    text-align: center;
}

.controls-section {
    margin-bottom: 20px;
}

.filter-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.checkbox-control {
    display: flex;
    align-items: center;
    margin-right: 15px;
}

.checkbox-control input {
    margin-right: 5px;
}

#formularioImputarHoras h3, #historialHorasTarea h3 {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üöÄ Sistema de Seguimiento IT GESTAGUA</h1>
        <p>Control completo de tareas, horas y progreso de tu equipo</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('registro')">üìù Registro de Tareas</button>
        <button class="tab" onclick="showTab('daily')">üìÖ Vista Daily</button>
        <button class="tab" onclick="showTab('personas')">üë• Vista por Persona</button>
        <button class="tab" onclick="showTab('dashboard')">üìà Dashboard</button>
        <button class="tab" onclick="showTab('reportes')">üìã Reportes</button>
        <button class="tab" onclick="showTab('proyectos')">üèóÔ∏è Maestro de Proyectos</button>
        <button class="tab" onclick="showTab('usuarios')">üë§ Maestro de Usuarios</button>
    </div>

    <!-- TAB: Registro de Tareas -->
    <div id="registro" class="tab-content active">
        <div class="controls-section">
            <div class="filter-controls">
                <div class="checkbox-control">
                    <input type="checkbox" id="mostrarInactivas" onchange="mostrarTareas()">
                    <label for="mostrarInactivas">Mostrar tareas inactivas</label>
                </div>
                <button onclick="mostrarFormularioTarea()" class="btn btn-primary">‚ûï Nueva Tarea</button>
            </div>
        </div>
        
        <div class="table-container">
            <h3>üìÉ Listado de Tareas</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>√Årea</th>
                        <th>Proyecto</th>
                        <th>Descripci√≥n</th>
                        <th>Responsable</th>
                        <th>Estado</th>
                        <th>Progreso</th>
                        <th>Horas Est.</th>
                        <th>Horas Trab.</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaTareas">
                    <!-- Las tareas se cargar√°n aqu√≠ -->
                </tbody>
            </table>
        </div>
        
        <!-- Formulario para crear/editar tareas (inicialmente oculto) -->
        <div id="formularioTarea" class="form-section" style="display: none;">
            <h3 id="tituloFormularioTarea">‚ûï Nueva Tarea</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>√Årea</label>
                    <select id="area">
                        <option value="desarrollo">Desarrollo</option>
                        <option value="sistemas">Sistemas</option>
                        <option value="bbdd">Base de Datos</option>
                        <option value="bi">Business Intelligence</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Responsable</label>
                    <select id="responsable">
                        <option value="">Seleccionar responsable...</option>
                        <!-- Los usuarios se cargar√°n din√°micamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Proyecto</label>
                    <select id="proyecto">
                        <option value="">Seleccionar proyecto...</option>
                        <!-- Los proyectos se cargar√°n din√°micamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Prioridad</label>
                    <select id="prioridad">
                        <option value="alta">Alta</option>
                        <option value="media" selected>Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="estado">
                        <option value="pendiente">Pendiente</option>
                        <option value="en_progreso">En Progreso</option>
                        <option value="bloqueado">Bloqueado</option>
                        <option value="completado">Completado</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcion" placeholder="Descripci√≥n detallada de la tarea"></textarea>
                </div>
                <div class="form-group">
                    <label>Fecha Inicio</label>
                    <input type="date" id="fechaInicio">
                </div>
                <div class="form-group">
                    <label>Fecha Fin (estimada)</label>
                    <input type="date" id="fechaFin">
                </div>
                <div class="form-group">
                    <label>Horas Estimadas</label>
                    <input type="number" id="horasEstimadas" placeholder="0.0" min="0" step="0.5">
                </div>
            </div>
            <div class="form-actions">
                <button onclick="guardarTareaDirecto()" class="btn btn-primary">üíæ Guardar Tarea</button>
                <button onclick="cancelarFormularioTarea()" class="btn">‚ùå Cancelar</button>
            </div>
        </div>
        
        <!-- Formulario para imputar horas (inicialmente oculto) -->
        <div id="formularioImputarHoras" class="form-section" style="display: none;">
            <h3 id="tituloImputarHoras">‚è±Ô∏è Imputar Horas</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Usuario que registra las horas</label>
                    <select id="usuarioImputacion">
                        <option value="">Seleccionar usuario...</option>
                        <!-- Los usuarios se cargar√°n din√°micamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de Imputaci√≥n</label>
                    <input type="date" id="fechaImputacionDirecta">
                </div>
                <div class="form-group">
                    <label>Horas Trabajadas</label>
                    <input type="number" id="horasImputadas" placeholder="0.0" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>Comentarios</label>
                    <textarea id="comentariosImputacion" placeholder="Descripci√≥n del trabajo realizado"></textarea>
                </div>
                <!-- Progress is now calculated automatically based on hours worked -->
            </div>
            <div class="form-actions">
                <button onclick="imputarHorasTarea()" class="btn btn-primary">‚è∞ Registrar Horas</button>
                <button onclick="cancelarImputarHoras()" class="btn">‚ùå Cancelar</button>
            </div>
        </div>
        
        <!-- Historial de horas por tarea (inicialmente oculto) -->
        <div id="historialHorasTarea" class="form-section" style="display: none;">
            <h3 id="tituloHistorialHoras">üìÖ Historial de Horas</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Horas</th>
                            <th>Progreso</th>
                            <th>Comentarios</th>
                        </tr>
                    </thead>
                    <tbody id="tablaHistorialHoras">
                        <!-- El historial se cargar√° aqu√≠ -->
                    </tbody>
                </table>
            </div>
            <div class="form-actions">
                <button onclick="cerrarHistorialHoras()" class="btn">‚ùå Cerrar</button>
            </div>
        </div>
    </div>
    <!-- TAB: Vista Daily -->
    <div id="daily" class="tab-content">
        <div class="form-section">
            <h3>üìÖ Seleccionar Fecha para Daily</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Fecha Daily</label>
                    <input type="date" id="fechaDaily">
                </div>
                <div class="form-group">
                    <label>Filtrar por √Årea</label>
                    <select id="filtroAreaDaily">
                        <option value="">Todas las √°reas</option>
                        <option value="desarrollo">Desarrollo</option>
                        <option value="sistemas">Sistemas</option>
                        <option value="bbdd">Base de Datos</option>
                        <option value="bi">Business Intelligence</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="cargarDaily()">üîç Cargar Daily</button>
        </div>
        
        <div id="contenidoDaily" style="display: none;">
            <div class="form-section">
                <h3 id="tituloDaily">üìã Daily del [Fecha]</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>√Årea</th>
                                <th>Proyecto</th>
                                <th>Tarea</th>
                                <th>Horas</th>
                                <th>Progreso</th>
                                <th>Comentarios</th>
                            </tr>
                        </thead>
                        <tbody id="tareasDaily">
                            <!-- Las tareas se llenar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="form-section">
                <h3>‚ö†Ô∏è Alertas y Seguimiento</h3>
                <div id="alertasDaily"></div>
            </div>
        </div>
    </div>

    <!-- TAB: Vista por Persona -->
    <div id="personas" class="tab-content">
        <div class="form-section">
            <h3>üë• Seleccionar Persona</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Responsable</label>
                    <select id="selectorPersona">
                        <option value="">Seleccionar persona...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Per√≠odo</label>
                    <select id="periodoPersona">
                        <option value="7">√öltima semana</option>
                        <option value="15">√öltimos 15 d√≠as</option>
                        <option value="30">√öltimo mes</option>
                        <option value="todos">Todos los registros</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="cargarVistaPersona()">üëÅÔ∏è Ver Seguimiento</button>
        </div>
        
        <div id="contenidoPersona" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="tareasPersona">0</div>
                    <div class="stat-label">Tareas Asignadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completadasPersona">0</div>
                    <div class="stat-label">Completadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="horasPersona">0</div>
                    <div class="stat-label">Horas Trabajadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="eficienciaPersona">0%</div>
                    <div class="stat-label">Eficiencia</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 id="tituloPersona">üìä Seguimiento Detallado</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Proyecto</th>
                                <th>Tarea</th>
                                <th>Estado</th>
                                <th>Progreso</th>
                                <th>Horas Est.</th>
                                <th>Horas Real.</th>
                                <th>Desviaci√≥n</th>
                                <th>Fecha L√≠mite</th>
                                <th>Alerta</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPersona">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="form-section">
                <h3>üìà Historial de Actividad Diaria</h3>
                <div id="historialPersona"></div>
            </div>
        </div>
    </div>

    <!-- TAB: Dashboard -->
    <div id="dashboard" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalTareas">0</div>
                <div class="stat-label">Total Tareas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tareasCompletadas">0</div>
                <div class="stat-label">Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tareasEnProgreso">0</div>
                <div class="stat-label">En Progreso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="horasTotales">0</div>
                <div class="stat-label">Horas Totales</div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>üìä Resumen por √Årea</h3>
            <div id="resumenAreas"></div>
        </div>
    </div>

    <!-- TAB: Reportes -->
    <div id="reportes" class="tab-content">
        <div class="form-section">
            <h3>üìã Generar Reporte Semanal</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Fecha Desde</label>
                    <input type="date" id="fechaDesde">
                </div>
                <div class="form-group">
                    <label>Fecha Hasta</label>
                    <input type="date" id="fechaHasta">
                </div>
                <div class="form-group">
                    <label>Filtrar por √Årea</label>
                    <select id="filtroArea">
                        <option value="">Todas las √°reas</option>
                        <option value="desarrollo">Desarrollo</option>
                        <option value="sistemas">Sistemas</option>
                        <option value="bbdd">Base de Datos</option>
                        <option value="bi">Business Intelligence</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="generarReporte()">üìä Generar Reporte</button>
        </div>
        
        <div id="reporteResultado" class="form-section" style="display: none;">
            <h3>üìà Resultados del Reporte</h3>
            <div id="contenidoReporte"></div>
        </div>
    </div>
    
    <!-- TAB: Maestro de Proyectos -->
    <div id="proyectos" class="tab-content">
        <h3>üèóÔ∏è Maestro de Proyectos</h3>
        
        <div class="form-section">
            <h4>A√±adir Nuevo Proyecto</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre del Proyecto</label>
                    <input type="text" id="nombreProyecto" placeholder="Nombre del proyecto">
                </div>
                <div class="form-group">
                    <label>C√≥digo</label>
                    <input type="text" id="codigoProyecto" placeholder="C√≥digo identificativo">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcionProyecto" placeholder="Descripci√≥n del proyecto"></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="estadoProyecto">
                        <option value="activo">Activo</option>
                        <option value="pausado">Pausado</option>
                        <option value="completado">Completado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button onclick="agregarProyecto()" class="btn btn-primary">Guardar Proyecto</button>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <h4>Lista de Proyectos</h4>
            <table id="tablaProyectos" class="data-table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nombre</th>
                        <th>Descripci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los proyectos se cargar√°n aqu√≠ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- TAB: Maestro de Usuarios -->
    <div id="usuarios" class="tab-content">
        <h3>üë§ Maestro de Usuarios</h3>
        
        <div class="form-section">
            <h4>A√±adir Nuevo Usuario</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="nombreUsuario" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label>√Årea</label>
                    <select id="areaUsuario">
                        <option value="desarrollo">Desarrollo</option>
                        <option value="sistemas">Sistemas</option>
                        <option value="bbdd">Base de Datos</option>
                        <option value="bi">Business Intelligence</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailUsuario" placeholder="correo@ejemplo.com">
                </div>
                <div class="form-actions">
                    <button onclick="agregarUsuario()" class="btn btn-primary">Guardar Usuario</button>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <h4>Lista de Usuarios</h4>
            <table id="tablaUsuarios" class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>√Årea</th>
                        <th>Email</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los usuarios se cargar√°n aqu√≠ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Incluir los scripts externos -->
    <script src="js/api.js"></script>
    <script>

    function limpiarFormulario() {
        document.getElementById('responsable').value = '';
        document.getElementById('proyecto').value = '';
        document.getElementById('descripcion').value = '';
        document.getElementById('fechaInicio').value = '';
        document.getElementById('fechaFin').value = '';
        document.getElementById('horasEstimadas').value = '';
    }
// Variable global para controlar llamadas en progreso
let operacionGuardadoEnProgreso = false;

// Funci√≥n para guardar datos a trav√©s de la API
async function guardarDatos() {
    console.log('Guardando datos a trav√©s de la API...');
    
    // Evitar bucles infinitos y llamadas m√∫ltiples
    if (operacionGuardadoEnProgreso) {
        console.log('Ya hay una operaci√≥n de guardado en progreso, ignorando esta llamada');
        return;
    }
    
    operacionGuardadoEnProgreso = true;
    
    try {
        // Si es un click directo en el bot√≥n de guardar tarea, usar el manejador directo
        // que no vuelve a llamar a guardarDatos
        const formularioTarea = document.getElementById('formularioTarea');
        if (formularioTarea && formularioTarea.style.display !== 'none') {
            console.log('Formulario de tarea visible - ejecutando guardarTareaDirecto()');
            await guardarTareaDirecto();
            return;
        }
        
        // Si estamos en el contexto de imputar horas
        const formularioImputarHoras = document.getElementById('formularioImputarHoras');
        if (formularioImputarHoras && formularioImputarHoras.style.display !== 'none') {
            console.log('Formulario de imputar horas visible - ejecutando imputarHorasTarea()');
            await imputarHorasTarea();
            return;
        }
        
        // Si llegamos aqu√≠, probablemente se llam√≥ desde otra parte del c√≥digo
        // que a√∫n no ha sido adaptada para usar la API directamente
        console.log('Llamada gen√©rica a guardarDatos() - actualizando vista');
        
        // Recargar datos desde la API para asegurar sincronizaci√≥n
        registrosDiarios = await ApiClient.getDailyRecords();
        
        // Actualizar la interfaz
        mostrarTareas();
        actualizarDashboard();
    } catch (error) {
        console.error('Error en guardarDatos():', error);
        alert('Error al guardar los datos: ' + error.message);
    } finally {
        operacionGuardadoEnProgreso = false;
    }
}

// Funci√≥n directa para guardar tareas sin pasar por guardarDatos
async function guardarTareaDirecto() {
    console.log('guardarTareaDirecto() - Guardando tarea directamente');
    
    try {
        // Obtener valores del formulario
        const area = document.getElementById('area')?.value || '';
        const responsable = document.getElementById('responsable')?.value || '';
        const proyecto = document.getElementById('proyecto')?.value || '';
        const descripcion = document.getElementById('descripcion')?.value || '';
        const estado = document.getElementById('estado')?.value || 'activa';
        const prioridad = document.getElementById('prioridad')?.value || 'media';
        const fechaInicio = document.getElementById('fechaInicio')?.value || '';
        const fechaFin = document.getElementById('fechaFin')?.value || '';
        const horasEstimadas = parseFloat(document.getElementById('horasEstimadas')?.value) || 0;
        
        console.log('Valores del formulario:', {
            area, responsable, proyecto, descripcion, estado, prioridad,
            fechaInicio, fechaFin, horasEstimadas
        });
        
        // Validaciones b√°sicas
        if (!responsable || !proyecto || !descripcion) {
            alert('Por favor, completa los campos obligatorios: Responsable, Proyecto y Descripci√≥n');
            return;
        }
    
        // Preparar los datos para la API
        const taskData = {
            title: descripcion,
            description: descripcion,
            start_date: fechaInicio,
            end_date: fechaFin || null,
            estimated_hours: horasEstimadas,
            status: estado === 'activa' ? 'active' : 'inactive',
            project_id: parseInt(proyecto),
            assigned_to: parseInt(responsable),
            created_by: 1 // Asumimos usuario actual por defecto
        };
        
        console.log('Enviando datos a la API:', taskData);
        
        let resultado;
        
        if (tareaEnEdicion) {
            // Editar tarea existente usando la API
            console.log('Actualizando tarea existente ID:', tareaEnEdicion);
            resultado = await ApiClient.updateTask(tareaEnEdicion, taskData);
            
            if (resultado) {
                alert('‚úÖ Tarea actualizada correctamente');
            } else {
                throw new Error('No se pudo actualizar la tarea. El servidor no respondi√≥ correctamente.');
            }
        } else {
            // Crear nueva tarea usando la API
            console.log('Creando nueva tarea');
            resultado = await ApiClient.createTask(taskData);
            
            if (resultado && resultado.id) {
                contadorId = Math.max(contadorId, resultado.id + 1);
                alert('‚úÖ Tarea creada correctamente');
            } else {
                throw new Error('No se pudo crear la tarea. El servidor no devolvi√≥ un ID de tarea.');
            }
        }
        
        console.log('Resultado de la operaci√≥n:', resultado);
        
        // Limpiar y actualizar
        tareaEnEdicion = null;
        cancelarFormularioTarea();
        mostrarTareas();
        actualizarDashboard();
    } catch (error) {
        console.error('Error al guardar la tarea:', error);
        alert('‚ùå Error al guardar la tarea: ' + error.message);
    } finally {
        guardandoTarea = false;
    }
}


// Datos globales
let tareas = [];
let contadorId = 1;
let registrosDiarios = []; // Nuevo array para registros diarios

// Inicializar datos carg√°ndolos desde la API
async function inicializarDatos() {
    try {
        // Cargar tareas desde la API
        tareas = await ApiClient.getTasks();
        
        // Determinar el siguiente ID de tarea basado en el m√°ximo ID existente
        contadorId = tareas.length > 0 ? Math.max(...tareas.map(t => t.id)) + 1 : 1;
        
        // Cargar registros diarios desde la API
        registrosDiarios = await ApiClient.getDailyRecords();
        
        console.log('Datos cargados correctamente desde la API');
    } catch (error) {
        console.error('Error cargando datos desde la API, usando valores por defecto', error);
        tareas = [];
        contadorId = 1;
        registrosDiarios = [];
    }
}

// Funci√≥n para cambiar tabs
function showTab(tabName) {
    // Ocultar todos los tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar tab seleccionado
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    // Actualizar contenido si es necesario
    if (tabName === 'seguimiento') {
        mostrarTareas();
    } else if (tabName === 'dashboard') {
        actualizarDashboard();
    } else if (tabName === 'daily') {
        inicializarDaily();
    } else if (tabName === 'personas') {
        inicializarVistaPersonas();
    } else if (tabName === 'proyectos') {
        cargarProyectos();
    } else if (tabName === 'usuarios') {
        cargarUsuarios();
    }
}

async function agregarTarea() {
    try {
        // Obtener valores del formulario
        const area = document.getElementById('area')?.value || '';
        const responsable = document.getElementById('responsable')?.value || '';
        const proyecto = document.getElementById('proyecto')?.value || '';
        const descripcion = document.getElementById('descripcion')?.value || '';
        const estado = document.getElementById('estado')?.value || 'activa'; // Asegurarnos que sea 'activa' y no 'active'
        const prioridad = document.getElementById('prioridad')?.value || 'media';
        const fechaInicio = document.getElementById('fechaInicio')?.value || '';
        const fechaFin = document.getElementById('fechaFin')?.value || '';
        const horasEstimadas = parseFloat(document.getElementById('horasEstimadas')?.value) || 0;
        
        console.log('Valores del formulario:', {
            area, responsable, proyecto, descripcion, estado, prioridad,
            fechaInicio, fechaFin, horasEstimadas
        });
        
        // Validaciones b√°sicas
        if (!responsable || !proyecto || !descripcion) {
            alert('Por favor, completa los campos obligatorios: Responsable, Proyecto y Descripci√≥n');
            return;
        }
    
        // Preparar los datos para la API
        const taskData = {
            title: descripcion,
            description: descripcion,
            start_date: fechaInicio,
            end_date: fechaFin || null,
            estimated_hours: horasEstimadas,
            status: estado === 'activa' ? 'active' : 'inactive',
            project_id: parseInt(proyecto),
            assigned_to: parseInt(responsable),
            created_by: 1 // Asumimos usuario actual por defecto
        };
        
        console.log('Enviando datos a la API:', taskData);
        
        let resultado;
        
        if (tareaEnEdicion) {
            // Editar tarea existente usando la API
            console.log('Actualizando tarea existente ID:', tareaEnEdicion);
            resultado = await ApiClient.updateTask(tareaEnEdicion, taskData);
            
            if (resultado) {
                alert('‚úÖ Tarea actualizada correctamente');
            } else {
                throw new Error('No se pudo actualizar la tarea. El servidor no respondi√≥ correctamente.');
            }
        } else {
            // Crear nueva tarea usando la API
            console.log('Creando nueva tarea');
            resultado = await ApiClient.createTask(taskData);
            
            if (resultado && resultado.id) {
                contadorId = Math.max(contadorId, resultado.id + 1);
                alert('‚úÖ Tarea creada correctamente');
            } else {
                throw new Error('No se pudo crear la tarea. El servidor no devolvi√≥ un ID de tarea.');
            }
        }
        
        console.log('Resultado de la operaci√≥n:', resultado);
        
        // Limpiar y actualizar
        tareaEnEdicion = null;
        cancelarFormularioTarea();
        mostrarTareas();
        actualizarDashboard();
    } catch (error) {
        console.error('Error al guardar la tarea:', error);
        alert('‚ùå Error al guardar la tarea: ' + error.message);
    } finally {
        guardandoTarea = false;
    }
}

// Cancelar formulario de tarea
function cancelarFormularioTarea() {
    document.getElementById('formularioTarea').style.display = 'none';
    tareaEnEdicion = null;
}

// Editar una tarea existente
function editarTarea(id) {
    tareaEnEdicion = id;
    const tarea = tareas.find(t => t.id === id);
    if (!tarea) return;
    
    document.getElementById('formularioTarea').style.display = 'block';
    document.getElementById('formularioImputarHoras').style.display = 'none';
    document.getElementById('historialHorasTarea').style.display = 'none';
    
    document.getElementById('tituloFormularioTarea').textContent = `‚úèÔ∏è Editar Tarea: ${tarea.proyecto}`;
    
    // Llenar formulario con datos de la tarea
    document.getElementById('area').value = tarea.area;
    document.getElementById('responsable').value = tarea.responsable;
    document.getElementById('proyecto').value = tarea.proyecto;
    document.getElementById('prioridad').value = tarea.prioridad;
    document.getElementById('estado').value = tarea.estado;
    document.getElementById('descripcion').value = tarea.descripcion;
    document.getElementById('fechaInicio').value = tarea.fechaInicio || '';
    document.getElementById('fechaFin').value = tarea.fechaFin || '';
    document.getElementById('horasEstimadas').value = tarea.horasEstimadas;
}

// Mostrar formulario para imputar horas
function mostrarImputarHoras(id) {
    debugger;
    tareaSeleccionadaDirecta = id;
    const tarea = tareas.find(t => t.id === id);
    if (!tarea) return;
    
    document.getElementById('formularioTarea').style.display = 'none';
    document.getElementById('formularioImputarHoras').style.display = 'block';
    document.getElementById('historialHorasTarea').style.display = 'none';
    
    // Titulo con datos de la tarea
    document.getElementById('tituloImputarHoras').textContent = `‚è±Ô∏è Imputar Horas: ${tarea.project_name} - ${tarea.title.substring(0, 30)}${tarea.title.length > 30 ? '...' : ''}`;
    
    // Establecer fecha actual como predeterminada
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fechaImputacionDirecta').value = hoy;
    
    // Prepopular con el responsable de la tarea, pero permite cambiarlo
    document.getElementById('usuarioImputacion').value = ''; 
    document.getElementById('horasImputadas').value = '';
    document.getElementById('comentariosImputacion').value = '';
    
    // Cargar usuarios en el selector
    cargarSelectoresUsuariosImputacion();
}

// Cargar usuarios en el selector de imputaci√≥n
async function cargarSelectoresUsuariosImputacion() {
    const selectorUsuarios = document.getElementById('usuarioImputacion');
    if (selectorUsuarios) {
        //obtenemos los usuarios del api
        const usuarios = await ApiClient.getUsers();
        selectorUsuarios.innerHTML = '<option value="">Seleccionar usuario...</option>';
        if (usuarios.length > 0) {
            // Ordenar alfab√©ticamente por nombre
            usuarios.sort((a, b) => a.name.localeCompare(b.name));
            
            // A√±adir al selector
            usuarios.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.id;
                option.textContent = usuario.name;
                selectorUsuarios.appendChild(option);
            });
        } else {
          // SI no hay usuario mostramos log de error
          console.error('No se encontraron usuarios');
        }
    }
}

// Cancelar imputaci√≥n de horas
function cancelarImputarHoras() {
    document.getElementById('formularioImputarHoras').style.display = 'none';
    tareaSeleccionadaDirecta = null;
}

// Mostrar formulario para crear nueva tarea
function mostrarFormularioTarea() {
    // Ocultar otros formularios
    document.getElementById('formularioImputarHoras').style.display = 'none';
    document.getElementById('historialHorasTarea').style.display = 'none';
    
    // Mostrar formulario de tarea
    document.getElementById('formularioTarea').style.display = 'block';
    document.getElementById('tituloFormularioTarea').textContent = '‚ûï Nueva Tarea';
    
    // Limpiar campos del formulario
    document.getElementById('area').value = 'desarrollo';
    document.getElementById('responsable').value = '';
    document.getElementById('proyecto').value = '';
    document.getElementById('descripcion').value = '';
    document.getElementById('prioridad').value = 'media';
    document.getElementById('estado').value = 'pendiente';
    
    // Establecer fecha de hoy como predeterminada para inicio
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fechaInicio').value = hoy;
    document.getElementById('fechaFin').value = '';
    document.getElementById('horasEstimadas').value = '';
    
    // Indicar que estamos creando una nueva tarea
    tareaEnEdicion = null;
    
    // Cargar usuarios y proyectos en los selectores
    cargarSelectoresUsuarios();
    cargarSelectoresProyectos();
}

// Cancelar formulario de tarea
function cancelarFormularioTarea() {
    document.getElementById('formularioTarea').style.display = 'none';
    tareaEnEdicion = null;
}

// Agregar o editar tarea
function agregarTarea() {
    // Si estamos editando una tarea existente
    if (tareaEnEdicion) {
        const tareaIndex = tareas.findIndex(t => t.id === tareaEnEdicion);
        if (tareaIndex === -1) return;
        
        // Actualizar tarea existente
        const tarea = tareas[tareaIndex];
        tarea.area = document.getElementById('area').value;
        tarea.responsable = document.getElementById('responsable').value;
        tarea.proyecto = document.getElementById('proyecto').value;
        tarea.descripcion = document.getElementById('descripcion').value;
        tarea.estado = document.getElementById('estado').value;
        tarea.prioridad = document.getElementById('prioridad').value;
        tarea.fechaInicio = document.getElementById('fechaInicio').value;
        tarea.fechaFin = document.getElementById('fechaFin').value;
        tarea.horasEstimadas = parseFloat(document.getElementById('horasEstimadas').value) || 0;
        
        // Recalcular progreso basado en horas estimadas y trabajadas
        if (tarea.horasEstimadas > 0) {
            tarea.progreso = Math.min(100, Math.round((tarea.horasTrabajadas / tarea.horasEstimadas) * 100));
        }
        
        guardarDatos();
        tareaEnEdicion = null;
        mostrarTareas();
        cancelarFormularioTarea();
        alert('Tarea actualizada correctamente');
        return;
    }
    
    // Si estamos creando una tarea nueva
    const nuevaTarea = {
        id: contadorId++,
        area: document.getElementById('area').value,
        responsable: document.getElementById('responsable').value,
        proyecto: document.getElementById('proyecto').value,
        descripcion: document.getElementById('descripcion').value,
        estado: document.getElementById('estado').value,
        prioridad: document.getElementById('prioridad').value,
        fechaInicio: document.getElementById('fechaInicio').value,
        fechaFin: document.getElementById('fechaFin').value,
        horasEstimadas: parseFloat(document.getElementById('horasEstimadas').value) || 0,
        horasTrabajadas: 0,
        progreso: 0, // Siempre inicia en 0
        fechaCreacion: new Date().toISOString().split('T')[0]
    };
    
    // Validaciones b√°sicas
    if (!nuevaTarea.responsable || !nuevaTarea.proyecto || !nuevaTarea.descripcion) {
        alert('Por favor, completa los campos obligatorios: Responsable, Proyecto y Descripci√≥n');
        return;
    }
    
    tareas.push(nuevaTarea);
    guardarDatos();
    mostrarTareas();
    cancelarFormularioTarea();
    alert('Tarea creada correctamente');
}

// Imputar horas a una tarea
async function imputarHorasTarea() {
    if (!tareaSeleccionadaDirecta) return;
    
    const usuarioRegistra = document.getElementById('usuarioImputacion').value;
    const fechaImputacion = document.getElementById('fechaImputacionDirecta').value;
    const horasImputadas = parseFloat(document.getElementById('horasImputadas').value) || 0;
    const comentarios = document.getElementById('comentariosImputacion').value;
    
    // Validaciones
    if (!usuarioRegistra) {
        alert('Por favor selecciona el usuario que registra las horas');
        return;
    }
    
    if (!fechaImputacion) {
        alert('Por favor selecciona la fecha de imputaci√≥n');
        return;
    }
    
    if (horasImputadas <= 0) {
        alert('Por favor ingresa las horas trabajadas');
        return;
    }
    
    if (!comentarios) {
        alert('Por favor describe el trabajo realizado');
        return;
    }
    
    try {
        // Buscar la tarea actual
        const tarea = tareas.find(t => t.id === tareaSeleccionadaDirecta);
        if (!tarea) return;
        
        // Crear el objeto de registro diario para la API
        const dailyRecordData = {
            task_id: tareaSeleccionadaDirecta,
            user_id: parseInt(usuarioRegistra),
            date: fechaImputacion,
            hours: horasImputadas,
            comments: comentarios
        };
        
        // Llamar a la API para crear el registro diario
        await ApiClient.createDailyRecord(dailyRecordData);
        
        // Recargar datos desde la API
        tareas = await ApiClient.getTasks();
        registrosDiarios = await ApiClient.getDailyRecords();
        
        // Buscar la tarea actualizada para mostrar la informaci√≥n
        const tareaActualizada = tareas.find(t => t.id === tareaSeleccionadaDirecta);
        
        // Mostrar mensaje de √©xito
        if (tareaActualizada) {
            // Calcular el total acumulado y progreso
            const totalHoras = tareaActualizada.completed_hours || 0;
            let progreso = 0;
            
            if (tareaActualizada.estimated_hours > 0) {
                progreso = Math.min(100, Math.round((totalHoras / tareaActualizada.estimated_hours) * 100));
            }
            
            // Mostrar mensaje con la informaci√≥n actualizada
            alert(`‚úÖ Horas registradas correctamente.\nUsuario: ${usuarioRegistra}\nFecha: ${fechaImputacion}\nHoras: ${horasImputadas}h\nTotal acumulado: ${totalHoras}h\nProgreso calculado: ${progreso}%`);
            
            // Mostrar alerta si se excedi√≥ en horas
            if (totalHoras > tareaActualizada.estimated_hours) {
                const exceso = totalHoras - tareaActualizada.estimated_hours;
                alert(`‚ö†Ô∏è ALERTA: Esta tarea ha excedido las horas estimadas.\nHoras estimadas: ${tareaActualizada.estimated_hours}h\nHoras trabajadas: ${totalHoras}h\nExceso: ${exceso.toFixed(1)}h`);
            }
        } else {
            alert('‚úÖ Horas registradas correctamente.');
        }
        
        // Limpiar formulario y actualizar interfaz
        document.getElementById('formularioImputarHoras').style.display = 'none';
        mostrarTareas();
        actualizarDashboard();
    } catch (error) {
        console.error('Error al imputar horas:', error);
        alert('‚ùå Error al registrar las horas. Int√©ntalo nuevamente.');
    }
    
    // Limpiar y cerrar el formulario
    cancelarImputarHoras();
    mostrarTareas();
}

// Mostrar historial de horas de una tarea
function mostrarHistorialHorasTarea(id) {
    tareaSeleccionadaDirecta = id;
    const tarea = tareas.find(t => t.id === id);
    if (!tarea) return;
    
    document.getElementById('formularioTarea').style.display = 'none';
    document.getElementById('formularioImputarHoras').style.display = 'none';
    document.getElementById('historialHorasTarea').style.display = 'block';
    
    // Titulo con datos de la tarea
    document.getElementById('tituloHistorialHoras').textContent = `üìÖ Historial: ${tarea.proyecto} - ${tarea.descripcion.substring(0, 30)}${tarea.descripcion.length > 30 ? '...' : ''}`;
    
    // Obtener registros de esta tarea
    const registrosTarea = registrosDiarios.filter(r => r.tareaId === id);
    
    // Ordenar por fecha (m√°s reciente primero)
    registrosTarea.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    // Mostrar en la tabla
    const tabla = document.getElementById('tablaHistorialHoras');
    tabla.innerHTML = '';
    
    if (registrosTarea.length === 0) {
        const fila = tabla.insertRow();
        fila.innerHTML = '<td colspan="5" class="text-center">No hay registros de horas para esta tarea</td>';
        return;
    }
    
    registrosTarea.forEach(registro => {
        const fila = tabla.insertRow();
        
        // Formatear fecha a formato local
        const fecha = new Date(registro.fecha);
        const fechaFormateada = fecha.toLocaleDateString();
        
        fila.innerHTML = `
            <td>${fechaFormateada}</td>
            <td>${registro.usuarioRegistra || registro.responsable}</td>
            <td>${registro.horasTrabajadas}h</td>
            <td>${registro.progreso}%</td>
            <td>${registro.comentarios}</td>
        `;
    });
}

// Cerrar el historial de horas
function cerrarHistorialHoras() {
    document.getElementById('historialHorasTarea').style.display = 'none';
    tareaSeleccionadaDirecta = null;
}

// Funci√≥n para cambiar el estado de una tarea
async function cambiarEstadoTarea(id, estado) {
    try {
        // Llamar a la API para actualizar el estado de la tarea
        await ApiClient.updateTaskStatus(id, estado === 'activa' ? 'active' : 'inactive');
            
        // Actualizar la interfaz
        mostrarTareas();
        actualizarDashboard();
    } catch (error) {
        console.error('Error al cambiar estado de la tarea:', error);
        alert('‚ùå Error al cambiar el estado de la tarea. Int√©ntalo nuevamente.');
    }
}


// ==================== FUNCIONES PARA LAS TAREAS ====================
// Funci√≥n para mostrar tareas en la tabla
async function mostrarTareas() {
    // Recargar las tareas desde la API
    tareas = await ApiClient.getTasks();

    // Comprobar si queremos mostrar tareas inactivas
    const mostrarInactivas = document.getElementById('mostrarInactivas').checked;
    
    // Filtrar tareas seg√∫n el checkbox
    let tareasFiltradas = mostrarInactivas ? tareas : tareas.filter(t => t.estado !== 'inactivo');
    
    // Ordenar tareas: primero activas (no completadas), luego completadas, finalmente inactivas
    tareasFiltradas.sort((a, b) => {
        // Primero por estado
        if (a.estado === 'inactivo' && b.estado !== 'inactivo') return 1;
        if (a.estado !== 'inactivo' && b.estado === 'inactivo') return -1;
        if (a.estado === 'completado' && b.estado !== 'completado') return 1;
        if (a.estado !== 'completado' && b.estado === 'completado') return -1;
        
        // Luego por fecha de creaci√≥n (m√°s recientes primero)
        return new Date(b.fechaCreacion) - new Date(a.fechaCreacion);
    });
    
    // Mostrar en la tabla de tareas (pesta√±a principal)
    const tablaTareas = document.getElementById('tablaTareas');
    if (tablaTareas) {
        tablaTareas.innerHTML = '';
        if (tareasFiltradas.length === 0) {
            const fila = tablaTareas.insertRow();
            fila.innerHTML = '<td colspan="10" class="text-center">No hay tareas registradas</td>';
        } else {
            tareasFiltradas.forEach(tarea => {
                const fila = tablaTareas.insertRow();
                
                // Calcular desviaci√≥n en horas
                const desviacionHoras = tarea.estimated_hours - tarea.completed_hours;
                
                // Determinar clase CSS seg√∫n estado
                let filaClase = '';
                if (tarea.status === 'inactive') filaClase = 'fila-inactiva';
                else if (tarea.status === 'completed') filaClase = 'fila-completada';
                else if (tarea.status === 'blocked') filaClase = 'fila-bloqueada';
                
                // Verificar si est√° retrasada seg√∫n fecha fin
                const hoy = new Date().toISOString().split('T')[0];
                let retrasada = false;
                if (tarea.end_date && tarea.end_date < hoy && tarea.status !== 'completed' && tarea.status !== 'inactive') {
                    retrasada = true;
                    filaClase += ' fila-retrasada';
                }
                //Calculamos el progreso
                //Si no hay horas estimadas, el progreso es 0
                let progreso = 0;
                if (tarea.estimated_hours > 0) {
                    progreso = (tarea.completed_hours / tarea.estimated_hours) * 100;
                }
                tarea.progreso = progreso;
                fila.className = filaClase;
                
                fila.innerHTML = `
                    <td>${tarea.id}</td>
                    <td>${capitalizar(tarea.area)}</td>
                    <td>${tarea.project_name}</td>
                    <td>${tarea.description.substring(0, 30)}${tarea.description.length > 30 ? '...' : ''}</td>
                    <td>${tarea.assignee_name}</td>
                    <td><span class="status ${tarea.status}">${capitalizar(tarea.status)}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${tarea.progreso}%"></div>
                        </div>
                        ${tarea.progreso}%
                    </td>
                    <td>${tarea.estimated_hours}h</td>
                    <td>${tarea.completed_hours}h</td>
                    <td>
                        <button class="btn btn-sm" onclick="mostrarImputarHoras(${tarea.id})" title="Imputar horas">‚è±Ô∏è</button>
                        <button class="btn btn-sm" onclick="mostrarHistorialHorasTarea(${tarea.id})" title="Ver historial">üìä</button>
                        <button class="btn btn-sm" onclick="editarTarea(${tarea.id})" title="Editar tarea">‚úèÔ∏è</button>
                        ${tarea.status !== 'inactive' ? 
                          `<button class="btn btn-sm" onclick="cambiarEstadoTarea(${tarea.id}, 'inactive')" title="Marcar como inactiva">üö´</button>` :
                          `<button class="btn btn-sm" onclick="cambiarEstadoTarea(${tarea.id}, 'pending')" title="Reactivar tarea">‚Ü©Ô∏è</button>`
                        }
                    </td>
                `;
            });
        }
    }
}

// Variable para guardar el ID de la tarea seleccionada para imputar horas o ver historial
let tareaSeleccionadaDirecta = null;
let tareaEnEdicion = null;

// Funci√≥n para actualizar dashboard
function actualizarDashboard() {
    const totalTareas = tareas.length;
    const completadas = tareas.filter(t => t.estado === 'completado').length;
    const enProgreso = tareas.filter(t => t.estado === 'en_progreso').length;
    const horasTotales = tareas.reduce((sum, t) => sum + t.horasTrabajadas, 0);

    document.getElementById('totalTareas').textContent = totalTareas;
    document.getElementById('tareasCompletadas').textContent = completadas;
    document.getElementById('tareasEnProgreso').textContent = enProgreso;
    document.getElementById('horasTotales').textContent = horasTotales + 'h';

    // Resumen por √°rea
    const areas = ['desarrollo', 'sistemas', 'bbdd', 'bi'];
    const resumenContainer = document.getElementById('resumenAreas');
    resumenContainer.innerHTML = '';

    areas.forEach(area => {
        const tareasArea = tareas.filter(t => t.area === area);
        const completadasArea = tareasArea.filter(t => t.estado === 'completado').length;
        const horasArea = tareasArea.reduce((sum, t) => sum + t.horasTrabajadas, 0);

        const areaDiv = document.createElement('div');
        areaDiv.className = 'stat-card';
        areaDiv.innerHTML = `
            <h4>${capitalizar(area)}</h4>
            <p>Tareas: ${tareasArea.length} | Completadas: ${completadasArea}</p>
            <p>Horas trabajadas: ${horasArea}h</p>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${tareasArea.length ? (completadasArea/tareasArea.length)*100 : 0}%"></div>
            </div>
        `;
        resumenContainer.appendChild(areaDiv);
    });
}

// Funci√≥n para generar reporte
function generarReporte() {
    const fechaDesde = document.getElementById('fechaDesde').value;
    const fechaHasta = document.getElementById('fechaHasta').value;
    const filtroArea = document.getElementById('filtroArea').value;

    let tareasFiltradas = tareas;

    // Filtrar por fechas
    if (fechaDesde) {
        tareasFiltradas = tareasFiltradas.filter(t => t.fechaCreacion >= fechaDesde);
    }
    if (fechaHasta) {
        tareasFiltradas = tareasFiltradas.filter(t => t.fechaCreacion <= fechaHasta);
    }

    // Filtrar por √°rea
    if (filtroArea) {
        tareasFiltradas = tareasFiltradas.filter(t => t.area === filtroArea);
    }

    // Generar contenido del reporte
    const reporteDiv = document.getElementById('contenidoReporte');
    const totalHoras = tareasFiltradas.reduce((sum, t) => sum + t.horasTrabajadas, 0);
    const completadas = tareasFiltradas.filter(t => t.estado === 'completado').length;

    reporteDiv.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${tareasFiltradas.length}</div>
                <div class="stat-label">Tareas en el per√≠odo</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${completadas}</div>
                <div class="stat-label">Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${totalHoras}h</div>
                <div class="stat-label">Horas trabajadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${tareasFiltradas.length ? Math.round((completadas/tareasFiltradas.length)*100) : 0}%</div>
                <div class="stat-label">Tasa de finalizaci√≥n</div>
            </div>
        </div>
        <h4>Detalle por responsable:</h4>
        <div id="detalleResponsables"></div>
    `;

    // Detalle por responsable
    const responsables = [...new Set(tareasFiltradas.map(t => t.responsable))];
    const detalleDiv = document.getElementById('detalleResponsables');
    
    responsables.forEach(responsable => {
        const tareasResp = tareasFiltradas.filter(t => t.responsable === responsable);
        const horasResp = tareasResp.reduce((sum, t) => sum + t.horasTrabajadas, 0);
        const completadasResp = tareasResp.filter(t => t.estado === 'completado').length;
        
        const respDiv = document.createElement('div');
        respDiv.className = 'stat-card';
        respDiv.innerHTML = `
            <h5>${responsable}</h5>
            <p>Tareas: ${tareasResp.length} | Completadas: ${completadasResp} | Horas: ${horasResp}h</p>
        `;
        detalleDiv.appendChild(respDiv);
    });

    document.getElementById('reporteResultado').style.display = 'block';
}

// Funci√≥n para eliminar tarea
function eliminarTarea(id) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
        tareas = tareas.filter(t => t.id !== id);
        guardarDatos();
        mostrarTareas();
        actualizarDashboard();
    }
}

// Funci√≥n para exportar a Excel (CSV)
function exportarExcel() {
    let csv = '√Årea,Responsable,Proyecto,Descripci√≥n,Estado,Prioridad,Fecha Inicio,Fecha Fin,Horas Estimadas,Horas Trabajadas,Progreso %\n';
    
    tareas.forEach(tarea => {
        csv += `"${tarea.area}","${tarea.responsable}","${tarea.proyecto}","${tarea.descripcion}","${tarea.estado}","${tarea.prioridad}","${tarea.fechaInicio}","${tarea.fechaFin}","${tarea.horasEstimadas}","${tarea.horasTrabajadas}","${tarea.progreso}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `seguimiento_it_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// ==================== FUNCIONES VISTA DAILY ====================

function inicializarDaily() {
    // Establecer fecha de ayer por defecto para ver qu√© se hizo
    const ayer = new Date();
    ayer.setDate(ayer.getDate() - 1);
    document.getElementById('fechaDaily').value = ayer.toISOString().split('T')[0];
}

function cargarDaily() {
    const fechaSeleccionada = document.getElementById('fechaDaily').value;
    const areaFiltro = document.getElementById('filtroAreaDaily').value;
    
    if (!fechaSeleccionada) {
        alert('Por favor selecciona una fecha');
        return;
    }

    // Filtrar registros del d√≠a seleccionado
    let registrosDia = registrosDiarios.filter(r => r.fecha === fechaSeleccionada);
    
    if (areaFiltro) {
        registrosDia = registrosDia.filter(r => r.area === areaFiltro);
    }

    // Mostrar contenido
    document.getElementById('contenidoDaily').style.display = 'block';
    document.getElementById('tituloDaily').textContent = `üìã Daily del ${fechaSeleccionada}`;
    
    const tablaDaily = document.getElementById('tareasDaily');
    tablaDaily.innerHTML = '';

    if (registrosDia.length === 0) {
        tablaDaily.innerHTML = '<tr><td colspan="7" class="text-center">No hay registros para esta fecha y filtros seleccionados.</td></tr>';
        return;
    }
    
    // Ordenar por usuario y luego por proyecto
    registrosDia.sort((a, b) => {
        const usuarioA = a.usuarioRegistra || a.responsable;
        const usuarioB = b.usuarioRegistra || b.responsable;
        
        if (usuarioA !== usuarioB) {
            return usuarioA.localeCompare(usuarioB);
        }
        return a.proyecto.localeCompare(b.proyecto);
    });
    
    // Para calcular los totales por usuario
    const horasPorUsuario = {};
    
    // Mostrar cada registro como una fila en la tabla
    registrosDia.forEach(registro => {
        const fila = tablaDaily.insertRow();
        
        // Determinar el usuario que realiz√≥ el trabajo (registr√≥ las horas)
        const usuario = registro.usuarioRegistra || registro.responsable;
        
        // Acumular horas por usuario para mostrar totales
        if (!horasPorUsuario[usuario]) {
            horasPorUsuario[usuario] = 0;
        }
        horasPorUsuario[usuario] += registro.horasTrabajadas;
        
        // Obtener la tarea completa para comprobar si excede las horas estimadas
        const tareaCompleta = tareas.find(t => t.id === registro.tareaId);
        const excedida = tareaCompleta && tareaCompleta.horasTrabajadas > tareaCompleta.horasEstimadas;
        
        // Aplicar clase a la fila si la tarea excede las horas estimadas
        if (excedida) {
            fila.className = 'fila-excedida';
        }
        
        // Agregar las celdas con la informaci√≥n
        fila.innerHTML = `
            <td>${usuario}</td>
            <td><span class="area-tag ${registro.area}">${capitalizar(registro.area)}</span></td>
            <td>${registro.proyecto}</td>
            <td>${registro.descripcionTarea.substring(0, 50)}${registro.descripcionTarea.length > 50 ? '...' : ''}</td>
            <td>${registro.horasTrabajadas}h</td>
            <td>
                <div class="progress-bar">
                    <div class="progress" style="width: ${registro.progreso}%"></div>
                </div>
                ${registro.progreso}%
            </td>
            <td>${registro.comentarios}</td>
        `;
    });
    
    // Agregar fila de resumen con el total de horas por usuario
    Object.keys(horasPorUsuario).forEach(usuario => {
        const totalHoras = horasPorUsuario[usuario];
        const filaResumen = tablaDaily.insertRow();
        filaResumen.className = 'fila-resumen';
        filaResumen.innerHTML = `
            <td colspan="4"><strong>Total horas de ${usuario}:</strong></td>
            <td><strong>${totalHoras}h</strong></td>
            <td colspan="2"></td>
        `;
    });

    // Generar alertas
    generarAlertasDaily(fechaSeleccionada);
}

function generarAlertasDaily(fecha) {
    const alertasContainer = document.getElementById('alertasDaily');
    alertasContainer.innerHTML = '';
    
    // Obtener tareas que deber√≠an haber tenido actividad
    const tareasActivas = tareas.filter(t => 
        t.estado === 'en-progreso' && 
        new Date(t.fechaInicio) <= new Date(fecha) &&
        (!t.fechaFin || new Date(t.fechaFin) >= new Date(fecha))
    );
    
    const registrosDia = registrosDiarios.filter(r => r.fecha === fecha);
    const personasConActividad = [...new Set(registrosDia.map(r => r.responsable))];
    const personasActivas = [...new Set(tareasActivas.map(t => t.responsable))];
    
    // Personas sin actividad
    const personasSinActividad = personasActivas.filter(p => !personasConActividad.includes(p));
    
    if (personasSinActividad.length > 0) {
        const alertaDiv = document.createElement('div');
        alertaDiv.className = 'alerta advertencia';
        alertaDiv.innerHTML = `‚ö†Ô∏è <strong>Sin actividad registrada:</strong> ${personasSinActividad.join(', ')}`;
        alertasContainer.appendChild(alertaDiv);
    }
    
    // Tareas con retraso
    const tareasConRetraso = tareasActivas.filter(t => 
        t.fechaFin && new Date(fecha) > new Date(t.fechaFin) && t.estado !== 'completado'
    );
    
    if (tareasConRetraso.length > 0) {
        const alertaDiv = document.createElement('div');
        alertaDiv.className = 'alerta critica';
        alertaDiv.innerHTML = `üö® <strong>Tareas con retraso:</strong> ${tareasConRetraso.length} tareas pasaron su fecha l√≠mite`;
        alertasContainer.appendChild(alertaDiv);
    }
    
    // Tareas que exceden horas estimadas
    const tareasExcedidas = tareas.filter(t => t.horasTrabajadas > t.horasEstimadas);
    
    if (tareasExcedidas.length > 0) {
        const alertaDiv = document.createElement('div');
        alertaDiv.className = 'alerta advertencia';
        alertaDiv.innerHTML = `‚ö†Ô∏è <strong>Tareas con horas excedidas:</strong> ${tareasExcedidas.length} tareas superan las horas estimadas`;
        
        // Agregar detalle de tareas excedidas
        if (tareasExcedidas.length <= 5) { // Solo mostrar detalle si hay pocas tareas excedidas
            const detalleHTML = tareasExcedidas.map(t => {
                const exceso = (t.horasTrabajadas - t.horasEstimadas).toFixed(1);
                return `<li>${t.proyecto} - ${t.descripcion.substring(0, 30)}... (${t.horasTrabajadas}h / ${t.horasEstimadas}h est., exceso: ${exceso}h)</li>`;
            }).join('');
            
            alertaDiv.innerHTML += `<ul style="margin-top: 8px; font-size: 0.9em;">${detalleHTML}</ul>`;
        }
        
        alertasContainer.appendChild(alertaDiv);
    }
    
    if (personasSinActividad.length === 0 && tareasConRetraso.length === 0 && tareasExcedidas.length === 0) {
        const alertaDiv = document.createElement('div');
        alertaDiv.className = 'alerta info';
        alertaDiv.innerHTML = `‚úÖ <strong>Sin alertas:</strong> Todo el equipo registr√≥ actividad correctamente`;
        alertasContainer.appendChild(alertaDiv);
    }
}

// ==================== FUNCIONES ACTUALIZAR HORAS ====================

let tareaSeleccionadaId = null;

function inicializarActualizarHoras() {
    try {
        // Establecer fechas de hoy como predeterminadas
        const hoy = new Date().toISOString().split('T')[0];
        
        // Comprobar si los elementos existen antes de intentar acceder a ellos
        const fechaDesde = document.getElementById('fechaImputacionDesde');
        const fechaHasta = document.getElementById('fechaImputacionHasta');
        
        if (fechaDesde) fechaDesde.value = hoy;
        if (fechaHasta) fechaHasta.value = hoy;
        
        // Cargar lista de responsables
        const responsables = [...new Set(tareas.map(t => t.responsable))].filter(p => p);
        const selectResponsable = document.getElementById('responsableFiltro');
        
        if (selectResponsable) {
            selectResponsable.innerHTML = '<option value="">Seleccionar responsable...</option>';
            responsables.forEach(responsable => {
                const option = document.createElement('option');
                option.value = responsable;
                option.textContent = responsable;
                selectResponsable.appendChild(option);
            });
        }
        
        // Limpiar campo de b√∫squeda
        const buscarTarea = document.getElementById('buscarTarea');
        if (buscarTarea) buscarTarea.value = '';
    } catch (error) {
        console.error('Error en inicializarActualizarHoras:', error);
    }
}

function inicializarVistaPersonas() {
    const selectorPersona = document.getElementById('selectorPersona');
    selectorPersona.innerHTML = '<option value="">Seleccionar persona...</option>';
    
    // Usar la lista de usuarios del maestro en lugar de extraerlos de las tareas
    const usuariosMaestro = JSON.parse(localStorage.getItem('usuariosMaestro') || '[]');
    
    if (usuariosMaestro.length > 0) {
        // Ordenar alfab√©ticamente por nombre
        usuariosMaestro.sort((a, b) => a.nombre.localeCompare(b.nombre));
        
        // A√±adir al selector
        usuariosMaestro.forEach(usuario => {
            const option = document.createElement('option');
            option.value = usuario.nombre;
            option.textContent = usuario.nombre;
            selectorPersona.appendChild(option);
        });
    } else {
        // Si no hay usuarios en el maestro, usar los responsables de las tareas como fallback
        const responsables = [...new Set(tareas.map(t => t.responsable))].filter(r => r);
        responsables.sort();
        
        responsables.forEach(resp => {
            const option = document.createElement('option');
            option.value = resp;
            option.textContent = resp;
            selectorPersona.appendChild(option);
        });
    }
}

function filtrarTareasResponsable() {
    const responsable = document.getElementById('responsableFiltro').value;
    const departamento = document.getElementById('departamentoFiltro').value;
    const estado = document.getElementById('estadoFiltro').value;
    
    // Iniciar con todas las tareas
    let tareasFiltradas = [...tareas];
    
    // Aplicar filtros si est√°n seleccionados
    if (responsable) {
        tareasFiltradas = tareasFiltradas.filter(t => t.responsable === responsable);
    }
    
    if (departamento) {
        tareasFiltradas = tareasFiltradas.filter(t => t.area === departamento);
    }
    
    if (estado) {
        tareasFiltradas = tareasFiltradas.filter(t => t.estado === estado);
    }
    
    // Mostrar tareas disponibles si hay resultados
    if (tareasFiltradas.length > 0 || responsable || departamento || estado) {
        mostrarTareasActualizar(tareasFiltradas);
    } else {
        document.getElementById('tareasDisponibles').style.display = 'none';
    }
}

function buscarTareasPorNombre() {
    const textoBusqueda = document.getElementById('buscarTarea').value.toLowerCase();
    
    if (!textoBusqueda) {
        alert('Por favor ingresa un texto para buscar');
        return;
    }
    
    // Buscar en nombre de proyecto y descripci√≥n
    const tareasFiltradas = tareas.filter(t => 
        t.proyecto.toLowerCase().includes(textoBusqueda) || 
        t.descripcion.toLowerCase().includes(textoBusqueda)
    );
    
    mostrarTareasActualizar(tareasFiltradas);
}

function mostrarTareasActualizar(tareasFiltradas) {
    const contenedor = document.getElementById('listaTareasActualizar');
    contenedor.innerHTML = '';
    
    if (tareasFiltradas.length === 0) {
        contenedor.innerHTML = '<div class="alerta info">No hay tareas disponibles con los criterios seleccionados.</div>';
        document.getElementById('tareasDisponibles').style.display = 'block';
        return;
    }
    
    tareasFiltradas.forEach(tarea => {
        const tareaDiv = document.createElement('div');
        tareaDiv.className = 'tarea-actualizar';
        tareaDiv.setAttribute('data-id', tarea.id);
        
        // Calcular si est√° excedida en horas
        const excedida = tarea.horasTrabajadas > tarea.horasEstimadas;
        const claseBorde = excedida ? 'borde-excedido' : '';
        const iconoExcedido = excedida ? '‚ö†Ô∏è ' : '';
        
        tareaDiv.innerHTML = `
            <div class="tarea-header ${claseBorde}">
                <span><strong>${iconoExcedido}${tarea.proyecto}</strong> - ${tarea.descripcion.substring(0, 50)}${tarea.descripcion.length > 50 ? '...' : ''}</span>
                <span class="status ${tarea.estado}">${capitalizar(tarea.estado)}</span>
            </div>
            <div class="tarea-details">
                <div>Progreso: ${tarea.progreso}%</div>
                <div>Horas estimadas: ${tarea.horasEstimadas}h</div>
                <div>Horas trabajadas: ${tarea.horasTrabajadas}h ${excedida ? '<span style="color: #dc3545;">‚ö†Ô∏è Excedido</span>' : ''}</div>
                <div>Fecha l√≠mite: ${tarea.fechaFin || 'No definida'}</div>
            </div>
            <button class="btn btn-sm" onclick="seleccionarTareaActualizar(${tarea.id})">Actualizar esta tarea</button>
        `;
        
        contenedor.appendChild(tareaDiv);
    });
    
    document.getElementById('tareasDisponibles').style.display = 'block';
}

function seleccionarTareaActualizar(id) {
    tareaSeleccionadaId = id;
    const tarea = tareas.find(t => t.id === id);
    
    if (!tarea) return;
    
    // Mostrar el formulario de actualizaci√≥n
    document.getElementById('tituloTareaSeleccionada').textContent = `‚úèÔ∏è Actualizar: ${tarea.proyecto} - ${tarea.descripcion.substring(0, 30)}${tarea.descripcion.length > 30 ? '...' : ''}`;
    
    // Establecer fecha actual como predeterminada para imputaci√≥n
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fechaImputacion').value = hoy;
    
    // Prepopular con el responsable de la tarea, pero permite cambiarlo
    document.getElementById('usuarioRegistra').value = tarea.responsable; 
    
    // Configurar campos de actualizaci√≥n
    document.getElementById('nuevoProgreso').value = tarea.progreso;
    document.getElementById('horasHoy').value = '';
    document.getElementById('comentariosHoy').value = '';
    document.getElementById('nuevoEstado').value = '';
    
    // Mostrar resumen de la tarea
    const resumenHTML = `
        <div><strong>√Årea:</strong> ${capitalizar(tarea.area)}</div>
        <div><strong>Responsable:</strong> ${tarea.responsable}</div>
        <div><strong>Estado actual:</strong> <span class="status ${tarea.estado}">${capitalizar(tarea.estado)}</span></div>
        <div><strong>Progreso actual:</strong> ${tarea.progreso}%</div>
        <div><strong>Horas estimadas:</strong> ${tarea.horasEstimadas}h</div>
        <div><strong>Horas trabajadas:</strong> ${tarea.horasTrabajadas}h</div>
        <div><strong>Fecha inicio:</strong> ${tarea.fechaInicio || 'No definida'}</div>
        <div><strong>Fecha fin:</strong> ${tarea.fechaFin || 'No definida'}</div>
    `;
    
    document.getElementById('resumenTarea').innerHTML = resumenHTML;
    document.getElementById('actualizarHorasForm').style.display = 'block';
}

function actualizarHorasTarea() {
    if (!tareaSeleccionadaId) return;
    
    const usuarioRegistra = document.getElementById('usuarioRegistra').value;
    const fechaImputacion = document.getElementById('fechaImputacion').value;
    const horasHoy = parseFloat(document.getElementById('horasHoy').value) || 0;
    const nuevoProgreso = parseInt(document.getElementById('nuevoProgreso').value);
    const nuevoEstado = document.getElementById('nuevoEstado').value;
    const comentariosHoy = document.getElementById('comentariosHoy').value;
    
    // Validaciones
    if (!usuarioRegistra) {
        alert('Por favor ingresa el nombre del usuario que registra las horas');
        return;
    }
    
    if (!fechaImputacion) {
        alert('Por favor selecciona la fecha de imputaci√≥n');
        return;
    }
    
    if (horasHoy <= 0) {
        alert('Por favor ingresa las horas trabajadas');
        return;
    }
    
    if (isNaN(nuevoProgreso) || nuevoProgreso < 0 || nuevoProgreso > 100) {
        alert('Por favor ingresa un porcentaje de progreso v√°lido (0-100)');
        return;
    }
    
    if (!comentariosHoy) {
        alert('Por favor describe el trabajo realizado');
        return;
    }
    
    // Actualizar la tarea
    const tareaIndex = tareas.findIndex(t => t.id === tareaSeleccionadaId);
    if (tareaIndex === -1) return;
    
    const tarea = tareas[tareaIndex];
    
    // Actualizar datos de la tarea
    tarea.horasTrabajadas += horasHoy;
    tarea.progreso = nuevoProgreso;
    if (nuevoEstado) tarea.estado = nuevoEstado;
    
    // Si se complet√≥ la tarea y no tiene fecha fin, establecer hoy como fecha fin
    if (tarea.estado === 'completado' && !tarea.fechaFin) {
        tarea.fechaFin = fechaImputacion;
    }
    
    // Crear registro diario - ahora usando el usuario que registra las horas
    const registroDiario = {
        id: Date.now(),
        tareaId: tarea.id,
        fecha: fechaImputacion,
        responsable: tarea.responsable,  // Mantener el responsable original de la tarea
        usuarioRegistra: usuarioRegistra, // Nuevo campo: quien registra las horas
        proyecto: tarea.proyecto,
        descripcionTarea: tarea.descripcion,
        horasTrabajadas: horasHoy,
        comentarios: comentariosHoy,
        progreso: nuevoProgreso,
        area: tarea.area
    };
    
    registrosDiarios.push(registroDiario);
    
    // Guardar datos
    guardarDatos();
    
    // Mostrar mensaje
    alert(`‚úÖ Tarea actualizada correctamente.
Usuario: ${usuarioRegistra}
Fecha: ${fechaImputacion}
Horas a√±adidas: ${horasHoy}h
Total horas: ${tarea.horasTrabajadas}h
Progreso: ${nuevoProgreso}%`);
    
    // Mostrar alerta si se excedi√≥ en horas
    if (tarea.horasTrabajadas > tarea.horasEstimadas) {
        const exceso = tarea.horasTrabajadas - tarea.horasEstimadas;
        alert(`‚ö†Ô∏è ALERTA: Esta tarea ha excedido las horas estimadas.
Horas estimadas: ${tarea.horasEstimadas}h
Horas trabajadas: ${tarea.horasTrabajadas}h
Exceso: ${exceso.toFixed(1)}h`);
    }
    
    // Limpiar formulario y refrescar vista
    cancelarActualizacion();
    filtrarTareasResponsable();
}

function cancelarActualizacion() {
    tareaSeleccionadaId = null;
}

// ==================== FUNCIONES VISTA POR PERSONA ====================

function inicializarDaily() {
    // Cargar √°reas en el filtro
    const selectArea = document.getElementById('filtroAreaDaily');
    selectArea.innerHTML = '<option value="">Todas las √°reas</option>';
    
    ['desarrollo', 'sistemas', 'bbdd', 'bi'].forEach(area => {
        selectArea.innerHTML += `<option value="${area}">${capitalizar(area)}</option>`;
    });
    
    // Establecer la fecha de ayer como predeterminada
    const ayer = new Date();
    ayer.setDate(ayer.getDate() - 1);
    const fechaAyer = ayer.toISOString().split('T')[0];
    document.getElementById('fechaDaily').value = fechaAyer;
    
    // Cargar autom√°ticamente los registros de ayer
    cargarDaily();
}

function cargarVistaPersona() {
    const personaSeleccionada = document.getElementById('selectorPersona').value;
    const periodo = document.getElementById('periodoPersona').value;
    
    if (!personaSeleccionada) {
        alert('Por favor selecciona una persona');
        return;
    }

    // Filtrar tareas de la persona
    let tareasPersona = tareas.filter(t => t.responsable === personaSeleccionada);
    
    // Filtrar por per√≠odo
    if (periodo !== 'todos') {
        const diasAtras = parseInt(periodo);
        const fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - diasAtras);
        tareasPersona = tareasPersona.filter(t => new Date(t.fechaCreacion) >= fechaLimite);
    }

    // Mostrar estad√≠sticas
    const totalTareas = tareasPersona.length;
    const completadas = tareasPersona.filter(t => t.estado === 'completado').length;
    const horasTotales = tareasPersona.reduce((sum, t) => sum + t.horasTrabajadas, 0);
    const horasEstimadas = tareasPersona.reduce((sum, t) => sum + t.horasEstimadas, 0);
    const eficiencia = horasEstimadas > 0 ? Math.round((horasEstimadas / horasTotales) * 100) : 0;

    document.getElementById('tareasPersona').textContent = totalTareas;
    document.getElementById('completadasPersona').textContent = completadas;
    document.getElementById('horasPersona').textContent = horasTotales + 'h';
    document.getElementById('eficienciaPersona').textContent = eficiencia + '%';

    // Mostrar tabla detallada
    const tbody = document.getElementById('tablaPersona');
    tbody.innerHTML = '';

    tareasPersona.forEach(tarea => {
        const fila = document.createElement('tr');
        const desviacion = tarea.horasTrabajadas - tarea.horasEstimadas;
        const alertaTiempo = desviacion > (tarea.horasEstimadas * 0.2) ? '‚ö†Ô∏è Sobrecosto' : 
                           desviacion < 0 ? '‚úÖ En tiempo' : '‚ûñ Normal';
        
        const fechaLimite = new Date(tarea.fechaFin);
        const hoy = new Date();
        const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
        const alertaFecha = tarea.fechaFin && diasRestantes < 0 ? 'üö® Retrasada' :
                          tarea.fechaFin && diasRestantes <= 2 ? '‚ö†Ô∏è Urgente' : '‚úÖ A tiempo';

        fila.innerHTML = `
            <td>${tarea.proyecto}</td>
            <td>${tarea.descripcion.substring(0, 40)}...</td>
            <td><span class="status ${tarea.estado}">${capitalizar(tarea.estado)}</span></td>
            <td>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${tarea.progreso}%"></div>
                </div>
                ${tarea.progreso}%
            </td>
            <td>${tarea.horasEstimadas}h</td>
            <td>${tarea.horasTrabajadas}h</td>
            <td style="color: ${desviacion > 0 ? '#dc3545' : '#28a745'}">${desviacion > 0 ? '+' : ''}${desviacion.toFixed(1)}h</td>
            <td>${tarea.fechaFin || 'No definida'}</td>
            <td>${alertaTiempo}<br>${alertaFecha}</td>
        `;
        tbody.appendChild(fila);
    });

    // Mostrar historial de actividad diaria
    mostrarHistorialPersona(personaSeleccionada, periodo);

    document.getElementById('contenidoPersona').style.display = 'block';
    document.getElementById('tituloPersona').textContent = `üìä Seguimiento de ${personaSeleccionada}`;
}

function mostrarHistorialPersona(persona, periodo) {
    const historialContainer = document.getElementById('historialPersona');
    
    let registrosPersona = registrosDiarios.filter(r => r.responsable === persona);
    
    // Filtrar por per√≠odo
    if (periodo !== 'todos') {
        const diasAtras = parseInt(periodo);
        const fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - diasAtras);
        registrosPersona = registrosPersona.filter(r => new Date(r.fecha) >= fechaLimite);
    }

    historialContainer.innerHTML = '';

    if (registrosPersona.length === 0) {
        historialContainer.innerHTML = '<div class="alerta info">No hay registros de actividad para este per√≠odo.</div>';
        return;
    }

    // Agrupar por fecha
    const porFecha = {};
    registrosPersona.forEach(registro => {
        if (!porFecha[registro.fecha]) {
            porFecha[registro.fecha] = [];
        }
        porFecha[registro.fecha].push(registro);
    });

    // Ordenar fechas (m√°s reciente primero)
    const fechasOrdenadas = Object.keys(porFecha).sort((a, b) => new Date(b) - new Date(a));

    fechasOrdenadas.forEach(fecha => {
        const registrosFecha = porFecha[fecha];
        const totalHorasDia = registrosFecha.reduce((sum, r) => sum + r.horasTrabajadas, 0);
        
        const fechaDiv = document.createElement('div');
        fechaDiv.className = 'historial-dia';
        
        let contenido = `
            <div class="fecha-historial">üìÖ ${fecha} - Total: ${totalHorasDia}h</div>
        `;
        
        registrosFecha.forEach(registro => {
            contenido += `
                <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>${registro.proyecto}</strong></span>
                        <span class="area-tag ${registro.area}">${capitalizar(registro.area)}</span>
                    </div>
                    <div style="margin: 4px 0; font-size: 0.9em; color: #6c757d;">${registro.descripcionTarea}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                        <span>‚è∞ ${registro.horasTrabajadas}h</span>
                        <span>üìä ${registro.progreso}%</span>
                    </div>
                    ${registro.comentarios ? `<div style="margin-top: 6px; padding: 6px; background: #e9f7ef; border-radius: 4px; font-size: 0.85em; font-style: italic;">üí¨ ${registro.comentarios}</div>` : ''}
                </div>
            `;
        });
        
        fechaDiv.innerHTML = contenido;
        historialContainer.appendChild(fechaDiv);
    });
}

// Funciones auxiliares
function capitalizar(str) {
    return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
}



// ==================== FUNCIONES MAESTRO DE PROYECTOS ====================

// Array para almacenar los proyectos
let proyectos = [];
let contadorIdProyecto = 1;

// Inicializar datos de proyectos desde la API
async function inicializarProyectos() {
    try {
        // Cargar proyectos desde la API
        proyectos = await ApiClient.getProjects();
        
        // Determinar el siguiente ID de proyecto basado en el m√°ximo ID existente
        contadorIdProyecto = proyectos.length > 0 ? Math.max(...proyectos.map(p => p.id)) + 1 : 1;
        
        console.log('Proyectos cargados correctamente desde la API:', proyectos.length, 'proyectos');
    } catch (error) {
        console.error('Error cargando proyectos desde la API, usando valores por defecto', error);
        proyectos = [];
        contadorIdProyecto = 1;
    }
}

// Cargar proyectos y actualizar la tabla y selectores
async function cargarProyectos() {
    try {
        await inicializarProyectos();
        cargarTablaProyectos();
        cargarSelectoresProyectos();
        console.log('Proyectos cargados y actualizados en la interfaz');
    } catch (error) {
        console.error('Error al cargar proyectos:', error);
        alert('Error al cargar la lista de proyectos. Intente nuevamente.');
    }
    // Cargar selectores de proyectos en el formulario de tareas
    cargarSelectoresProyectos();
}

// Guardar datos de proyectos en la API
// Esta funci√≥n ya no es necesaria pues cada operaci√≥n CRUD llama directamente a la API
async function guardarProyectos() {
    console.log('La funci√≥n guardarProyectos() ya no es necesaria, los datos se guardan directamente en la API');
    // Esta funci√≥n se mantiene para compatibilidad con el c√≥digo existente
}

// Agregar un nuevo proyecto
async function agregarProyecto() {
    try {
        const nombre = document.getElementById('nombreProyecto').value;
        const codigo = document.getElementById('codigoProyecto').value;
        const descripcion = document.getElementById('descripcionProyecto').value;
        const estado = document.getElementById('estadoProyecto').value;
        
        if (!nombre || !codigo) {
            alert('Por favor, ingresa al menos el nombre y c√≥digo del proyecto.');
            return;
        }
        
        // Verificar si ya existe un proyecto con el mismo c√≥digo
        if (proyectos.some(p => p.codigo === codigo || p.code === codigo)) {
            alert('Ya existe un proyecto con este c√≥digo. Por favor, utiliza otro c√≥digo.');
            return;
        }
        
        // Crear datos para la API
        const projectData = {
            name: nombre,
            code: codigo,
            description: descripcion || '',
            active: estado === 'activo' ? 1 : 0
        };
        
        console.log('Creando nuevo proyecto:', projectData);
        
        // Llamar a la API para crear el proyecto
        const resultado = await ApiClient.createProject(projectData);
        
        if (resultado && resultado.id) {
            console.log('Proyecto creado correctamente:', resultado);
            contadorIdProyecto = Math.max(contadorIdProyecto, resultado.id + 1);
            
            // Recargar proyectos desde la API
            await inicializarProyectos();
            
            // Limpiar formulario
            document.getElementById('nombreProyecto').value = '';
            document.getElementById('codigoProyecto').value = '';
            document.getElementById('descripcionProyecto').value = '';
            document.getElementById('estadoProyecto').value = 'activo';
            
            // Actualizar tabla y selectores
            cargarTablaProyectos();
            cargarSelectoresProyectos();
            
            alert('‚úÖ Proyecto guardado correctamente');
        } else {
            throw new Error('No se pudo crear el proyecto. El servidor no devolvi√≥ un ID de proyecto.');
        }
    } catch (error) {
        console.error('Error al crear proyecto:', error);
        alert('‚ùå Error al guardar el proyecto: ' + error.message);
    }
}

// Cargar la tabla de proyectos
function cargarTablaProyectos() {
    const tabla = document.getElementById('tablaProyectos').getElementsByTagName('tbody')[0];
    tabla.innerHTML = '';
    
    proyectos.forEach(proyecto => {
        const fila = tabla.insertRow();
        
        const celdaCodigo = fila.insertCell(0);
        celdaCodigo.textContent = proyecto.id;
        
        const celdaNombre = fila.insertCell(1);
        celdaNombre.textContent = proyecto.name;
        
        const celdaDescripcion = fila.insertCell(2);
        celdaDescripcion.textContent = proyecto.description;
        
        const celdaEstado = fila.insertCell(3);

        if(proyecto.active==1){
            celdaEstado.innerHTML = `<span class="status activo">Activo</span>`;
        }else{
            celdaEstado.innerHTML = `<span class="status inactivo">Inactivo</span>`;
        }
        
        const celdaAcciones = fila.insertCell(4);
        celdaAcciones.innerHTML = `
            <button class="btn btn-sm" onclick="editarProyecto(${proyecto.id})">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="eliminarProyecto(${proyecto.id})">‚ùå</button>
        `;
    });
}

// Cargar selectores de proyectos
async function cargarSelectoresProyectos() {
    // Cargar selector en el formulario de tareas
    const selectorTareas = document.getElementById('proyecto');
    //obtenemos del api los proyectos
    const proyectos = await ApiClient.getProjects();

    const proyectosActivos = proyectos.filter(p => p.active === true);
    
    // Mantener la primera opci√≥n y limpiar el resto
    selectorTareas.innerHTML = '<option value="">Seleccionar proyecto...</option>';
    
    proyectosActivos.forEach(proyecto => {
        const option = document.createElement('option');
        option.value = proyecto.id;  // Usamos el nombre para mantener compatibilidad con datos existentes
        option.textContent = `${proyecto.name}`;
        selectorTareas.appendChild(option);
    });
}

// Editar proyecto
function editarProyecto(id) {
    alert('Funcionalidad de edici√≥n en desarrollo...');
    // Implementaci√≥n futura: mostrar un modal para editar el proyecto
}

// Eliminar proyecto
async function eliminarProyecto(id) {
    try {
        if (!confirm('¬øEst√°s seguro de que deseas eliminar este proyecto? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        // Buscar el proyecto en el array local
        const proyectoIndex = proyectos.findIndex(p => p.id === id);
        if (proyectoIndex === -1) {
            alert('Proyecto no encontrado.');
            return;
        }
        
        const proyecto = proyectos[proyectoIndex];
        
        // Verificar si hay tareas asociadas a este proyecto
        // Primero obtenemos todas las tareas actualizadas
        const todasLasTareas = await ApiClient.getTasks();
        const nombreProyecto = proyecto.name || proyecto.nombre; // Compatibilidad con ambos formatos
        
        const tareasAsociadas = todasLasTareas.filter(t => {
            const proyectoTarea = t.proyecto || t.project;
            return proyectoTarea === nombreProyecto;
        });
        
        if (tareasAsociadas.length > 0) {
            alert(`No se puede eliminar este proyecto porque tiene ${tareasAsociadas.length} tareas asociadas.`);
            return;
        }
        
        console.log(`Eliminando proyecto con ID: ${id}`);
        
        // Llamar a la API para eliminar el proyecto
        const resultado = await ApiClient.deleteProject(id);
        
        if (resultado && resultado.message === 'success') {
            console.log('Proyecto eliminado correctamente en la API');
            
            // Actualizar el array local solo despu√©s de √©xito en la API
            proyectos = proyectos.filter(p => p.id !== id);
            
            // Actualizar vista
            cargarTablaProyectos();
            cargarSelectoresProyectos();
            
            alert('‚úÖ Proyecto eliminado correctamente');
        } else {
            throw new Error('No se pudo eliminar el proyecto en la API. ' + (resultado?.message || ''));
        }
    } catch (error) {
        console.error('Error al eliminar proyecto:', error);
        alert('‚ùå Error al eliminar el proyecto: ' + error.message);
    }
}


// ==================== FUNCIONES MAESTRO DE USUARIOS ====================

// Array para almacenar los usuarios
let usuarios = [];
let contadorIdUsuario = 1;

// Inicializar datos de usuarios desde la API
async function inicializarUsuarios() {
    try {
        // Cargar usuarios desde la API
        usuarios = await ApiClient.getUsers();
        
        // Determinar el siguiente ID de usuario basado en el m√°ximo ID existente
        contadorIdUsuario = usuarios.length > 0 ? Math.max(...usuarios.map(u => u.id)) + 1 : 1;
        
        console.log('Usuarios cargados correctamente desde la API:', usuarios.length, 'usuarios');
    } catch (error) {
        console.error('Error cargando usuarios desde la API, usando valores por defecto', error);
        usuarios = [];
        contadorIdUsuario = 1;
    }
}

// Cargar usuarios y actualizar la tabla y selectores
async function cargarUsuarios() {
    try {
        await inicializarUsuarios();
        cargarTablaUsuarios();
        cargarSelectoresUsuarios();
        console.log('Usuarios cargados y actualizados en la interfaz');
    } catch (error) {
        console.error('Error al cargar usuarios:', error);
        alert('Error al cargar la lista de usuarios. Intente nuevamente.');
    }
    cargarSelectoresUsuarios();
}

// Guardar datos de usuarios en la API
// Esta funci√≥n ya no es necesaria pues cada operaci√≥n CRUD llama directamente a la API
async function guardarUsuarios() {
    console.log('La funci√≥n guardarUsuarios() ya no es necesaria, los datos se guardan directamente en la API');
    // Esta funci√≥n se mantiene para compatibilidad con el c√≥digo existente
}

// Agregar un nuevo usuario
async function agregarUsuario() {
    try {
        const nombre = document.getElementById('nombreUsuario').value;
        const email = document.getElementById('emailUsuario').value;
        const rol = document.getElementById('areaUsuario').value;
        
        if (!nombre || !email) {
            alert('Por favor, ingresa al menos el nombre y email del usuario.');
            return;
        }
        
        // Verificar si ya existe un usuario con el mismo email
        if (usuarios.some(u => u.email === email)) {
            alert('Ya existe un usuario con este email. Por favor, utiliza otro email.');
            return;
        }
        
        // Crear datos para la API
        const userData = {
            name: nombre,
            email: email,
            role: rol,
            active: true
        };
        
        console.log('Creando nuevo usuario:', userData);
        
        // Llamar a la API para crear el usuario
        const resultado = await ApiClient.createUser(userData);
        
        if (resultado && resultado.id) {
            console.log('Usuario creado correctamente:', resultado);
            contadorIdUsuario = Math.max(contadorIdUsuario, resultado.id + 1);
            
            // Recargar usuarios desde la API
            usuarios = await ApiClient.getUsers();
            
            // Limpiar formulario
            document.getElementById('nombreUsuario').value = '';
            document.getElementById('emailUsuario').value = '';
            document.getElementById('areaUsuario').value = 'desarrollo';
            
            // Actualizar tabla y selectores
            cargarTablaUsuarios();
            cargarSelectoresUsuarios();
            
            alert('‚úÖ Usuario guardado correctamente');
        } else {
            throw new Error('No se pudo crear el usuario. El servidor no devolvi√≥ un ID de usuario.');
        }
    } catch (error) {
        console.error('Error al crear usuario:', error);
        alert('‚ùå Error al guardar el usuario: ' + error.message);
    }
}

// Cargar la tabla de usuarios
function cargarTablaUsuarios() {
    const tabla = document.getElementById('tablaUsuarios').getElementsByTagName('tbody')[0];
    tabla.innerHTML = '';
    
    usuarios.forEach(usuario => {
        const fila = tabla.insertRow();
        
        const celdaId = fila.insertCell(0);
        celdaId.textContent = usuario.id;

        const celdaNombre = fila.insertCell(1);
        celdaNombre.textContent = usuario.name;
        
        const celdaRol = fila.insertCell(2);
        celdaRol.textContent = usuario.role;
        
        const celdaEmail = fila.insertCell(3);
        celdaEmail.textContent = usuario.email;
        
        const celdaActivo = fila.insertCell(4);
        celdaActivo.textContent = usuario.active ? 'S√≠' : 'No';
        
        const celdaAcciones = fila.insertCell(5);
        celdaAcciones.innerHTML = `
            <button class="btn btn-sm" onclick="editarUsuario(${usuario.id})">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="eliminarUsuario(${usuario.id})">‚ùå</button>
        `;
    });
}

// Cargar selectores de usuarios
function cargarSelectoresUsuarios() {
    // Cargar selector en el formulario de tareas
    const selectorTareas = document.getElementById('responsable');
    // Mantener la primera opci√≥n y limpiar el resto
    selectorTareas.innerHTML = '<option value="">Seleccionar responsable...</option>';
    
    usuarios.forEach(usuario => {
        const option = document.createElement('option');
        option.value = usuario.id;  // Usamos el nombre para mantener compatibilidad con datos existentes
        option.textContent = usuario.name;
        selectorTareas.appendChild(option);
    });
    
    // Tambi√©n actualizar el selector en la tab de actualizar horas
    const selectorResponsableFiltro = document.getElementById('responsableFiltro');
    if (selectorResponsableFiltro) {
        selectorResponsableFiltro.innerHTML = '<option value="">Seleccionar responsable...</option>';
        usuarios.forEach(usuario => {
            const option = document.createElement('option');
            option.value = usuario.id;
            option.textContent = usuario.name;
            selectorResponsableFiltro.appendChild(option);
        });
    }
    
    // Y el selector de usuario que registra horas
    const selectorUsuarioRegistra = document.getElementById('usuarioRegistra');
    if (selectorUsuarioRegistra) {
        selectorUsuarioRegistra.innerHTML = '<option value="">Seleccionar usuario...</option>';
        usuarios.forEach(usuario => {
            const option = document.createElement('option');
            option.value = usuario.id;
            option.textContent = usuario.name;
            selectorUsuarioRegistra.appendChild(option);
        });
    }
}

// Editar usuario
function editarUsuario(id) {
    alert('Funcionalidad de edici√≥n en desarrollo...');
    // Implementaci√≥n futura: mostrar un modal para editar el usuario
}

// Eliminar usuario
async function eliminarUsuario(id) {
    try {
        if (!confirm('¬øEst√°s seguro de que deseas eliminar este usuario? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        // Buscar el usuario en el array local
        const usuarioIndex = usuarios.findIndex(u => u.id === id);
        if (usuarioIndex === -1) {
            alert('Usuario no encontrado.');
            return;
        }
        
        const usuario = usuarios[usuarioIndex];
        
        // Verificar si hay tareas asignadas a este usuario
        // Primero obtenemos todas las tareas actualizadas
        const todasLasTareas = await ApiClient.getTasks();
        const nombreUsuario = usuario.name || usuario.nombre; // Compatibilidad con ambos formatos
        
        const tareasAsignadas = todasLasTareas.filter(t => {
            const responsable = t.responsable || t.responsible;
            return responsable === nombreUsuario;
        });
        
        if (tareasAsignadas.length > 0) {
            alert(`No se puede eliminar este usuario porque tiene ${tareasAsignadas.length} tareas asignadas.`);
            return;
        }
        
        console.log(`Eliminando usuario con ID: ${id}`);
        
        // Llamar a la API para eliminar el usuario
        const resultado = await ApiClient.deleteUser(id);
        
        if (resultado && resultado.message === 'success') {
            console.log('Usuario eliminado correctamente en la API');
            
            // Actualizar el array local solo despu√©s de √©xito en la API
            usuarios = usuarios.filter(u => u.id !== id);
            
            // Actualizar vista
            cargarTablaUsuarios();
            cargarSelectoresUsuarios();
            
            alert('‚úÖ Usuario eliminado correctamente');
        } else {
            throw new Error('No se pudo eliminar el usuario en la API. ' + (resultado?.message || ''));
        }
    } catch (error) {
        console.error('Error al eliminar usuario:', error);
        alert('‚ùå Error al eliminar el usuario: ' + error.message);
    }
}


// ==================== INICIALIZAR LA APP ====================

// Inicializar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar datos
    // inicializarDatos();
    // inicializarProyectos();
    inicializarUsuarios();
    
    // Establecer fecha de hoy como predeterminada
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fechaDaily').value = hoy;
    document.getElementById('filtroAreaDaily').value = '';
    
    // Inicializar todas las vistas
    inicializarDaily();
    inicializarActualizarHoras();
    inicializarVistaPersonas();
    
    // Mostrar tareas y actualizar dashboard
    mostrarTareas();
    actualizarDashboard();
});

// // Inicializar la aplicaci√≥n
// document.addEventListener('DOMContentLoaded', function() {
//     // Inicializar datos
//     inicializarDatos();
    
//     // Establecer fecha de hoy como predeterminada
//     const hoy = new Date().toISOString().split('T')[0];
//     document.getElementById('fechaInicio').value = hoy;
//     document.getElementById('fechaDesde').value = hoy;
//     document.getElementById('fechaHasta').value = hoy;
    
//     // Cargar datos si existen
//     mostrarTareas();
//     actualizarDashboard();
// });

</script>
</body>
</html>